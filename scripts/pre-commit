#!/bin/bash
# Claude Code Review Pre-Commit Hook
# Reviews staged changes before allowing commit
#
# Install: ./scripts/install-hooks.sh
# Skip: git commit --no-verify

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Check if claude CLI is available
if ! command -v claude &> /dev/null; then
    echo -e "${YELLOW}Warning: Claude CLI not found, skipping code review${NC}"
    exit 0
fi

# Get staged files (excluding deleted files)
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

if [ -z "$STAGED_FILES" ]; then
    exit 0
fi

# Count staged files
FILE_COUNT=$(echo "$STAGED_FILES" | wc -l | tr -d ' ')

echo -e "${YELLOW}Running Claude code review on $FILE_COUNT staged file(s)...${NC}"

# Create temp file with staged diff
DIFF_FILE=$(mktemp)
trap "rm -f $DIFF_FILE" EXIT

git diff --cached > "$DIFF_FILE"

# Check diff size - skip if too large (>50KB)
DIFF_SIZE=$(wc -c < "$DIFF_FILE" | tr -d ' ')
if [ "$DIFF_SIZE" -gt 51200 ]; then
    echo -e "${YELLOW}Diff too large ($DIFF_SIZE bytes), skipping detailed review${NC}"
    exit 0
fi

# Run Claude code review
REVIEW_PROMPT="Review this git diff for:
1. Bugs or logic errors
2. Security vulnerabilities
3. Code quality issues

Be concise. If there are CRITICAL issues that should block the commit, start your response with 'BLOCK:' followed by the reason.
If the changes are acceptable, start with 'PASS:' followed by any minor suggestions.

Diff:
$(cat "$DIFF_FILE")"

echo ""
REVIEW_OUTPUT=$(echo "$REVIEW_PROMPT" | claude --print 2>/dev/null || echo "PASS: Review skipped (Claude unavailable)")

echo "$REVIEW_OUTPUT"
echo ""

# Check if review recommends blocking
if echo "$REVIEW_OUTPUT" | grep -q "^BLOCK:"; then
    echo -e "${RED}Commit blocked by code review.${NC}"
    echo -e "${YELLOW}Fix the issues above and try again, or use 'git commit --no-verify' to skip.${NC}"
    exit 1
fi

echo -e "${GREEN}Code review passed.${NC}"
exit 0
