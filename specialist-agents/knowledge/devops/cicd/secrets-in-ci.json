{
  "metadata": {
    "version": "1.0.0",
    "updated": "2025-01-15",
    "category": "devops/cicd",
    "description": "Patterns for detecting and preventing secret exposure in CI/CD"
  },
  "secret_exposure_vectors": {
    "log_output": {
      "severity": "high",
      "description": "Secrets printed to CI/CD logs",
      "examples": [
        "echo $API_KEY in shell scripts",
        "console.log(process.env) in Node.js",
        "print(os.environ) in Python",
        "Verbose mode exposing headers/auth"
      ],
      "detection": [
        "Search logs for secret patterns",
        "Monitor for unmasked secret warnings"
      ],
      "prevention": [
        "Never echo secrets",
        "Mask secrets in CI system settings",
        "Redact secrets in application logs",
        "Avoid -v/--verbose flags with auth"
      ]
    },
    "artifact_inclusion": {
      "severity": "high",
      "description": "Secrets bundled into build artifacts",
      "examples": [
        ".env file in container image",
        "Credentials in package tarball",
        "API keys in client-side bundles"
      ],
      "detection": [
        "Scan artifacts for secret patterns",
        "Check .dockerignore and .npmignore"
      ],
      "prevention": [
        "Use multi-stage builds",
        "Add secrets to ignore files",
        "Use secret scanning in CI"
      ]
    },
    "error_messages": {
      "severity": "medium",
      "description": "Secrets leaked in error output",
      "examples": [
        "Connection string in database error",
        "API key in HTTP client error",
        "Credentials in stack traces"
      ],
      "detection": [
        "Review error handling code",
        "Test error paths manually"
      ],
      "prevention": [
        "Sanitize error messages",
        "Use generic error responses",
        "Log details securely, not to stdout"
      ]
    },
    "cache_contamination": {
      "severity": "medium",
      "description": "Secrets persisted in CI cache",
      "examples": [
        "Cached .npmrc with auth token",
        "Cached gradle.properties with credentials",
        "Cached cloud CLI config"
      ],
      "detection": [
        "Audit cache paths",
        "Review cache key construction"
      ],
      "prevention": [
        "Exclude credential files from cache",
        "Use ephemeral credentials",
        "Clear sensitive data before caching"
      ]
    },
    "source_control": {
      "severity": "critical",
      "description": "Secrets committed to repository",
      "examples": [
        "API keys in code",
        ".env files committed",
        "Private keys in repo"
      ],
      "detection": [
        "Pre-commit hooks with secret scanning",
        "Repository scanning tools"
      ],
      "prevention": [
        "Use pre-commit hooks",
        "Enable GitHub secret scanning",
        "Add secret files to .gitignore"
      ]
    }
  },
  "detection_patterns": {
    "api_keys": {
      "generic": "[a-zA-Z0-9_-]{32,}",
      "aws_access_key": "AKIA[0-9A-Z]{16}",
      "aws_secret_key": "[a-zA-Z0-9+/]{40}",
      "github_token": "gh[pousr]_[A-Za-z0-9_]{36,}",
      "gitlab_token": "glpat-[A-Za-z0-9_-]{20,}",
      "npm_token": "npm_[A-Za-z0-9]{36}",
      "pypi_token": "pypi-[A-Za-z0-9_-]{32,}"
    },
    "private_keys": {
      "rsa": "-----BEGIN RSA PRIVATE KEY-----",
      "openssh": "-----BEGIN OPENSSH PRIVATE KEY-----",
      "ec": "-----BEGIN EC PRIVATE KEY-----",
      "generic": "-----BEGIN .* PRIVATE KEY-----"
    },
    "connection_strings": {
      "postgres": "postgres://[^:]+:[^@]+@",
      "mysql": "mysql://[^:]+:[^@]+@",
      "mongodb": "mongodb(\\+srv)?://[^:]+:[^@]+@",
      "redis": "redis://:[^@]+@"
    },
    "oauth": {
      "client_secret": "client.?secret.{0,5}['\"][a-zA-Z0-9_-]{20,}",
      "bearer_token": "Bearer [a-zA-Z0-9_-]{20,}"
    }
  },
  "ci_platform_masking": {
    "github_actions": {
      "automatic": "Secrets are automatically masked in logs",
      "manual": "Use ::add-mask:: workflow command",
      "example": "echo \"::add-mask::$MY_SECRET\""
    },
    "gitlab_ci": {
      "automatic": "Variables marked as 'masked' are hidden",
      "manual": "Use 'masked' flag in variable settings",
      "limitation": "Value must be at least 8 chars, single line"
    },
    "jenkins": {
      "automatic": "Credentials plugin masks bound variables",
      "manual": "Use maskPasswords step",
      "example": "withCredentials([string(credentialsId: 'secret', variable: 'SECRET')])"
    },
    "circleci": {
      "automatic": "Environment variables not echoed by default",
      "manual": "Use $BASH_ENV for sensitive values",
      "best_practice": "Use contexts for shared secrets"
    }
  },
  "secret_management_solutions": {
    "vault": {
      "type": "External secret manager",
      "integration": "Dynamic secrets, AppRole auth",
      "pros": ["Centralized", "Audit trail", "Dynamic secrets"],
      "cons": ["Additional infrastructure", "Complexity"]
    },
    "cloud_native": {
      "aws": "AWS Secrets Manager, SSM Parameter Store",
      "azure": "Azure Key Vault",
      "gcp": "Google Secret Manager",
      "pros": ["Integrated", "IAM-based access"],
      "cons": ["Cloud lock-in", "Per-secret costs"]
    },
    "ci_native": {
      "description": "Built-in secret storage in CI platform",
      "pros": ["Convenient", "No additional setup"],
      "cons": ["Limited audit", "Platform-specific"]
    },
    "oidc": {
      "description": "Keyless authentication via identity federation",
      "pros": ["No long-lived secrets", "Automatic rotation"],
      "cons": ["Setup complexity", "Provider support needed"]
    }
  },
  "scanning_tools": {
    "pre_commit": {
      "gitleaks": {
        "command": "gitleaks protect --staged",
        "description": "Fast secret scanner with pre-commit support"
      },
      "detect_secrets": {
        "command": "detect-secrets-hook --baseline .secrets.baseline",
        "description": "Yelp's secret detection with baseline"
      },
      "trufflehog": {
        "command": "trufflehog git file://. --only-verified",
        "description": "Finds verified secrets in git history"
      }
    },
    "ci_integration": {
      "github": "GitHub Secret Scanning (native)",
      "gitlab": "GitLab Secret Detection",
      "gitleaks_action": "gitleaks/gitleaks-action",
      "snyk": "Snyk Code secret detection"
    },
    "artifact_scanning": {
      "trivy": "trivy fs --scanners secret .",
      "grype": "Container image secret scanning",
      "custom": "Run gitleaks against build output"
    }
  },
  "remediation_workflow": {
    "exposed_secret": {
      "steps": [
        {
          "step": 1,
          "action": "Revoke the secret immediately",
          "note": "Don't wait to assess impact"
        },
        {
          "step": 2,
          "action": "Generate new credentials",
          "note": "Update all legitimate uses"
        },
        {
          "step": 3,
          "action": "Remove from source control history",
          "note": "Use git-filter-repo or BFG Repo-Cleaner",
          "command": "git filter-repo --invert-paths --path secrets.txt"
        },
        {
          "step": 4,
          "action": "Force push and notify team",
          "note": "Team members must re-clone"
        },
        {
          "step": 5,
          "action": "Audit for unauthorized access",
          "note": "Check cloud provider audit logs"
        },
        {
          "step": 6,
          "action": "Implement prevention controls",
          "note": "Pre-commit hooks, secret scanning"
        }
      ]
    }
  }
}
