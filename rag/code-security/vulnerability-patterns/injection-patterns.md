<!--
Copyright (c) 2025 Crash Override Inc. - https://crashoverride.com

SPDX-License-Identifier: GPL-3.0
-->

# Injection Vulnerability Patterns

## SQL Injection (CWE-89)

### Description
SQL injection occurs when user input is incorporated into SQL queries without proper sanitization, allowing attackers to modify query logic.

### Dangerous Patterns

**String Concatenation**
```python
# Python - VULNERABLE
query = "SELECT * FROM users WHERE id = " + user_id
cursor.execute(query)

# Python - VULNERABLE
query = f"SELECT * FROM users WHERE name = '{name}'"
cursor.execute(query)
```

```javascript
// JavaScript - VULNERABLE
const query = `SELECT * FROM users WHERE id = ${userId}`;
db.query(query);

// JavaScript - VULNERABLE
const query = "SELECT * FROM users WHERE name = '" + name + "'";
```

```java
// Java - VULNERABLE
String query = "SELECT * FROM users WHERE id = " + userId;
statement.executeQuery(query);
```

```go
// Go - VULNERABLE
query := "SELECT * FROM users WHERE id = " + userId
db.Query(query)
```

### Safe Patterns

**Parameterized Queries**
```python
# Python - SECURE
cursor.execute("SELECT * FROM users WHERE id = %s", (user_id,))

# Python with SQLAlchemy - SECURE
User.query.filter_by(id=user_id).first()
```

```javascript
// JavaScript - SECURE
db.query('SELECT * FROM users WHERE id = $1', [userId]);

// With ORM (Sequelize) - SECURE
User.findOne({ where: { id: userId } });
```

```java
// Java - SECURE
PreparedStatement ps = conn.prepareStatement("SELECT * FROM users WHERE id = ?");
ps.setInt(1, userId);
ResultSet rs = ps.executeQuery();
```

```go
// Go - SECURE
db.Query("SELECT * FROM users WHERE id = $1", userId)
```

### Detection Indicators
- String concatenation with `+` in SQL context
- Format strings (f-strings, template literals) with SQL
- Variables embedded in SQL string literals
- Dynamic SQL building without parameterization

---

## Command Injection (CWE-78)

### Description
Command injection occurs when user input is passed to system commands, allowing attackers to execute arbitrary commands.

### Dangerous Patterns

```python
# Python - VULNERABLE
import os
os.system(f"ping {host}")

import subprocess
subprocess.call("ping " + host, shell=True)
```

```javascript
// JavaScript - VULNERABLE
const { exec } = require('child_process');
exec(`ls ${userDir}`);

exec('cat ' + filename);
```

```java
// Java - VULNERABLE
Runtime.getRuntime().exec("ping " + host);

ProcessBuilder pb = new ProcessBuilder("sh", "-c", "ping " + host);
```

```go
// Go - VULNERABLE
exec.Command("sh", "-c", "ping "+host).Run()
```

### Safe Patterns

```python
# Python - SECURE
import subprocess
subprocess.run(["ping", "-c", "4", host], shell=False, check=True)

# With input validation
import re
if re.match(r'^[a-zA-Z0-9.-]+$', host):
    subprocess.run(["ping", "-c", "4", host])
```

```javascript
// JavaScript - SECURE
const { execFile } = require('child_process');
execFile('ls', [userDir]);

// With spawn (no shell)
const { spawn } = require('child_process');
spawn('ping', ['-c', '4', host]);
```

```java
// Java - SECURE
ProcessBuilder pb = new ProcessBuilder("ping", "-c", "4", host);
pb.start();
```

```go
// Go - SECURE
exec.Command("ping", "-c", "4", host).Run()
```

### Detection Indicators
- `os.system()`, `subprocess.call()` with `shell=True`
- `exec()`, `eval()` with user input
- Backticks or `$()` in shell strings
- Runtime.exec() with concatenated strings

---

## Cross-Site Scripting - XSS (CWE-79)

### Description
XSS occurs when user input is rendered in HTML without proper encoding, allowing attackers to inject malicious scripts.

### Dangerous Patterns

**Reflected/Stored XSS**
```javascript
// JavaScript - VULNERABLE
element.innerHTML = userInput;
document.write(userInput);

// jQuery - VULNERABLE
$('#content').html(userInput);
```

```python
# Python/Flask - VULNERABLE (with |safe filter)
return render_template('page.html', content=user_input)
# template: {{ content|safe }}

# Django - VULNERABLE
return HttpResponse(f"<div>{user_input}</div>")
```

```java
// Java/JSP - VULNERABLE
out.println("<div>" + userInput + "</div>");
```

### Safe Patterns

```javascript
// JavaScript - SECURE
element.textContent = userInput;

// With sanitization library
import DOMPurify from 'dompurify';
element.innerHTML = DOMPurify.sanitize(userInput);

// React - automatically escapes
return <div>{userInput}</div>;
```

```python
# Python/Flask - SECURE (auto-escaping)
return render_template('page.html', content=user_input)
# template: {{ content }}  (no |safe)

# Manual escaping
from markupsafe import escape
return f"<div>{escape(user_input)}</div>"
```

```java
// Java - SECURE
import org.owasp.encoder.Encode;
out.println("<div>" + Encode.forHtml(userInput) + "</div>");
```

### Detection Indicators
- `innerHTML`, `outerHTML` with user data
- `document.write()` with user input
- Template literals rendered as HTML
- `|safe` or `autoescape off` in templates
- jQuery `.html()` with user data

---

## LDAP Injection (CWE-90)

### Dangerous Patterns
```python
# VULNERABLE
ldap_filter = f"(&(uid={username})(userPassword={password}))"
ldap_conn.search(base_dn, ldap_filter)
```

### Safe Patterns
```python
# SECURE - escape special characters
from ldap3.utils.conv import escape_filter_chars
safe_username = escape_filter_chars(username)
ldap_filter = f"(&(uid={safe_username}))"
```

---

## XPath Injection (CWE-91)

### Dangerous Patterns
```python
# VULNERABLE
xpath = f"//users/user[name='{username}']"
tree.xpath(xpath)
```

### Safe Patterns
```python
# SECURE - parameterized XPath
tree.xpath("//users/user[name=$name]", name=username)
```
